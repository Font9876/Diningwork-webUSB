<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>MIDI Control Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  <style type="text/css">
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: #0f172a;
      background-image: radial-gradient(ellipse at top, #1e293b, #0f172a);
      color: #e2e8f0;
      cursor: default;
    }
    input[type=range] { -webkit-appearance: none; background: transparent; cursor: grab; width: 100%; }
    input[type=range]::-webkit-slider-runnable-track { background: #334155; height: 6px; border-radius: 3px; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; margin-top: -7px; background-color: #22d3ee; height: 20px; width: 20px; border-radius: 50%; border: 3px solid #f8fafc; box-shadow: 0 0 8px rgba(34, 211, 238, 0.7); transition: all 0.15s ease; }
    input[type=range]:active::-webkit-slider-thumb { cursor: grabbing; transform: scale(1.1); }
    .vertical-rssi-bar-container { border-radius: 9999px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.4); height: 100%; max-height: 250px; width: 1rem; position: relative; display: flex; align-items: flex-end; justify-content: center; }
    .vertical-rssi-bar { width: 100%; border-radius: 9999px; background-image: linear-gradient(to top, #ef4444, #f59e0b, #22c55e); transition: height 0.2s ease-out; }
  </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4 sm:p-6 lg:p-8">
  <div class="flex flex-col lg:flex-row w-full max-w-screen-2xl bg-slate-900/70 backdrop-blur-sm rounded-3xl shadow-2xl overflow-hidden border border-slate-700/80">
    <!-- Left Panel: Header, TX Settings -->
    <aside class="w-full lg:w-[45%] bg-slate-800/50 p-4 sm:p-6 lg:p-8 flex flex-col justify-between border-r border-slate-700">
        <div>
            <header class="pb-6 mb-6 border-b border-slate-700">
                <h1 class="text-4xl font-extrabold text-white mb-2 tracking-tighter"><span class="text-teal-400">MIDI</span> Controller</h1>
                <p class="text-slate-400 text-sm mb-6">Device Configuration &amp; Monitor</p>
                <div id="tx-status" class="text-center text-sm">
                    <p class="text-slate-400 uppercase font-medium text-xs tracking-wider">TX Status</p>
                    <p id="tx-connection-status" class="font-semibold text-red-400 text-lg">Disconnected</p>
                </div>
                <div id="tx-connection-buttons" class="mt-4">
                    <button id="connectTxButton" class="w-full px-6 py-3 bg-blue-600 text-white font-semibold rounded-xl shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-500/50 transition-all duration-200">Connect TX</button>
                    <button id="disconnectTxButton" class="w-full px-6 py-3 bg-slate-600 text-white font-semibold rounded-xl shadow-lg hover:bg-slate-700 focus:outline-none focus:ring-4 focus:ring-slate-500/50 hidden">Disconnect TX</button>
                </div>
            </header>
            <!-- Other TX controls would go here -->
        </div>
    </aside>

    <!-- Rightmost Thin Panel: RX Status & Vertical RSSI -->
    <div class="w-full lg:w-[55%] bg-slate-900 p-4 sm:p-6 lg:p-8 flex flex-col justify-start items-center">
        <h2 class="text-xl font-bold text-teal-300 text-center mb-4 lg:mb-6">Receiver Status</h2>
        <div id="rx-column-status" class="text-center text-sm mb-4 lg:mb-6">
            <p class="text-slate-400 uppercase font-medium text-xs tracking-wider">RX Status</p>
            <p id="rx-connection-status-col" class="font-semibold text-red-400 text-lg">Disconnected</p>
        </div>
        <div id="rx-connection-buttons" class="mb-8 w-full max-w-xs">
            <button id="connectRxButton" class="w-full px-4 py-2 bg-blue-600 text-white text-sm font-semibold rounded-lg shadow-md hover:bg-blue-700">Connect RX</button>
            <button id="disconnectRxButton" class="w-full px-4 py-2 bg-slate-600 text-white text-sm font-semibold rounded-lg shadow-md hover:bg-slate-700 hidden">Disconnect RX</button>
        </div>
        <div class="space-y-2 mb-8 w-full max-w-xs">
            <div class="flex flex-col items-center justify-center">
                <label for="rxEsbChannel-col" class="block text-sm font-medium text-slate-400 mb-1">ESB Channel</label>
                <span id="rxEsbChannel-value-col" class="font-mono text-cyan-300 text-sm font-semibold">0</span>
            </div>
            <input type="range" id="rxEsbChannel-col" min="0" max="100" class="w-full">
        </div>
        <div class="flex-grow flex flex-col items-center justify-center h-40 mt-auto">
            <span class="text-xs text-slate-500 font-mono mb-0.5 font-semibold">-20dBm</span>
            <div class="vertical-rssi-bar-container bg-slate-900 h-full w-4 rounded-full border border-slate-700 shadow-inner overflow-hidden">
                <div id="vertical-rssi-bar" class="vertical-rssi-bar" style="height: 0%;"></div>
            </div>
            <span id="rxRssi-value-col" class="text-sm font-mono text-cyan-300 font-semibold my-2">-- dBm</span>
            <span class="text-xs text-slate-500 font-mono mt-0.5 font-semibold">-100dBm</span>
        </div>
    </div>
  </div>

  <script>
    // --- Device Vendor IDs & Product IDs ---
    const TX_VID = 0x000a;
    const TX_PID = 0x000a;
    const RX_VID = 0x000a;
    const RX_PID = 0x001a;

    // --- DOM Elements ---
    const connectTxButton = document.getElementById('connectTxButton');
    const disconnectTxButton = document.getElementById('disconnectTxButton');
    const connectRxButton = document.getElementById('connectRxButton');
    const disconnectRxButton = document.getElementById('disconnectRxButton');
    const txConnectionStatusEl = document.getElementById('tx-connection-status');
    const rxConnectionStatusElCol = document.getElementById('rx-connection-status-col');
    const rxEsbChannelSliderCol = document.getElementById('rxEsbChannel-col');
    const rxEsbChannelValueElCol = document.getElementById('rxEsbChannel-value-col');
    const rxRssiValueElCol = document.getElementById('rxRssi-value-col');
    const verticalRssiBar = document.getElementById('vertical-rssi-bar');

    // --- WebUSB State ---
    let txDevice = null, rxDevice = null;
    let txInterfaceNumber, txEndpointIn, txEndpointOut;
    let rxInterfaceNumber, rxEndpointIn, rxEndpointOut;
    let txKeepReading = false, rxKeepReading = false;
    let rssiRequestIntervalId = null; 

    const textEncoder = new TextEncoder();
    const textDecoder = new TextDecoder();

    // --- Core Functions ---

    const sendRxCommand = async (commandChar) => {
        if (!rxDevice || !rxDevice.opened) return;
        try {
            const data = textEncoder.encode(commandChar);
            await rxDevice.transferOut(rxEndpointOut, data);
        } catch (error) {
            console.error("Send command to RX error:", error);
            disconnectDevice('rx');
        }
    };
    
    const sendChannelToRX = async (channel) => {
        if (!rxDevice || !rxDevice.opened) return;
        try {
            const data = new Uint8Array([0x43, channel]); // 'C'
            await rxDevice.transferOut(rxEndpointOut, data);
        } catch (error) {
            console.error("Send channel to RX error:", error);
            disconnectDevice('rx');
        }
    };
    
    async function readLoop(deviceType) {
        const device = deviceType === 'tx' ? txDevice : rxDevice;
        const endpointIn = deviceType === 'tx' ? txEndpointIn : rxEndpointIn;
        const getKeepReading = () => deviceType === 'tx' ? txKeepReading : rxKeepReading;

        let incomingData = "";
        while (getKeepReading()) {
            try {
                let result = await device.transferIn(endpointIn, 512);
                if (result.status === 'ok' && result.data.byteLength > 0) {
                    incomingData += textDecoder.decode(result.data, { stream: true });
                    let newlineIndex;
                    while ((newlineIndex = incomingData.indexOf('\n')) !== -1) {
                        const line = incomingData.slice(0, newlineIndex).trim();
                        incomingData = incomingData.slice(newlineIndex + 1);
                        if (line.startsWith('{')) {
                            try {
                                const parsedJson = JSON.parse(line);
                                if (deviceType === 'rx') {
                                    // Check if it's a full settings update
                                    if (parsedJson.esbChannel !== undefined) {
                                        populateRxUI(parsedJson);
                                    }
                                    // Always update RSSI if present
                                    if (parsedJson.rssi !== undefined) {
                                        updateRxRSSI(parsedJson.rssi);
                                    }
                                } else {
                                  // Handle TX data if needed
                                }
                            } catch (e) {
                                console.error(`JSON Parse Error (${deviceType.toUpperCase()}):`, e.message);
                            }
                        }
                    }
                }
            } catch (error) {
                console.log(`Read loop error on ${deviceType.toUpperCase()}:`, error.message);
                disconnectDevice(deviceType);
                break;
            }
        }
    }

    const connectDevice = async (deviceType, vendorId, productId) => {
        let deviceRef = deviceType === 'tx' ? txDevice : rxDevice;
        if (deviceRef && deviceRef.opened) return;

        try {
            const device = await navigator.usb.requestDevice({ filters: [{ vendorId, productId }] });
            if (!device) return;

            await device.open();
            if (device.configuration === null) await device.selectConfiguration(1);

            let interfaceNum, epIn, epOut;
            for (const iface of device.configuration.interfaces) {
                for (const alt of iface.alternates) {
                    if (alt.interfaceClass === 0xFF) {
                        interfaceNum = iface.interfaceNumber;
                        for (const ep of alt.endpoints) {
                            if (ep.direction === 'out') epOut = ep.endpointNumber;
                            if (ep.direction === 'in') epIn = ep.endpointNumber;
                        }
                    }
                }
            }

            if (interfaceNum === undefined) throw new Error("Interface not found.");

            await device.claimInterface(interfaceNum);
            await device.controlTransferOut({ requestType: 'class', recipient: 'interface', request: 0x22, value: 0x01, index: interfaceNum });

            if (deviceType === 'tx') {
                txDevice = device; txInterfaceNumber = interfaceNum; txEndpointIn = epIn; txEndpointOut = epOut; txKeepReading = true;
                readLoop('tx');
            } else {
                rxDevice = device; rxInterfaceNumber = interfaceNum; rxEndpointIn = epIn; rxEndpointOut = epOut; rxKeepReading = true;
                readLoop('rx');
                // Start polling for RSSI
                if (rssiRequestIntervalId) clearInterval(rssiRequestIntervalId);
                rssiRequestIntervalId = setInterval(() => sendRxCommand('R'), 250);
            }
            updateUIForConnection(deviceType, true);

        } catch (error) {
            console.error(`Connection failed for ${deviceType.toUpperCase()}:`, error.message);
            updateUIForConnection(deviceType, false);
        }
    };
    
    const disconnectDevice = async (deviceType) => {
        let device, ifaceNum;
        if (deviceType === 'tx') {
            device = txDevice; ifaceNum = txInterfaceNumber; txKeepReading = false;
        } else {
            device = rxDevice; ifaceNum = rxInterfaceNumber; rxKeepReading = false;
            // Stop polling for RSSI
            if (rssiRequestIntervalId) {
                clearInterval(rssiRequestIntervalId);
                rssiRequestIntervalId = null;
            }
        }
        if (!device) return;
        try {
            if (device.opened) {
                await device.releaseInterface(ifaceNum);
                await device.close();
            }
        } catch (error) {
            console.error(`Disconnect error for ${deviceType.toUpperCase()}:`, error.message);
        } finally {
            if (deviceType === 'tx') txDevice = null; else rxDevice = null;
            updateUIForConnection(deviceType, false);
        }
    };

    // --- UI Update Functions ---
    const updateUIForConnection = (deviceType, connected) => {
        const connectBtn = deviceType === 'tx' ? connectTxButton : connectRxButton;
        const disconnectBtn = deviceType === 'tx' ? disconnectTxButton : disconnectRxButton;
        const statusEl = deviceType === 'tx' ? txConnectionStatusEl : rxConnectionStatusElCol;

        connectBtn.classList.toggle('hidden', connected);
        disconnectBtn.classList.toggle('hidden', !connected);

        statusEl.textContent = connected ? 'Connected' : 'Disconnected';
        statusEl.classList.toggle('text-green-400', connected);
        statusEl.classList.toggle('text-red-400', !connected);

        if (!connected && deviceType === 'rx') {
             updateRxRSSI('--');
             rxEsbChannelValueElCol.textContent = '0';
             rxEsbChannelSliderCol.value = 0;
             verticalRssiBar.style.height = '0%';
        }
    };
    
    const populateRxUI = (settings) => {
        rxEsbChannelSliderCol.value = settings.esbChannel;
        rxEsbChannelValueElCol.textContent = settings.esbChannel;
    };

    const updateRxRSSI = (rssiValue) => {
        if (rssiValue === '--') {
            rxRssiValueElCol.textContent = '-- dBm';
            verticalRssiBar.style.height = '0%';
            return;
        }
        rxRssiValueElCol.textContent = `${rssiValue} dBm`;
        const minRssi = -100, maxRssi = -20;
        const percentage = Math.max(0, Math.min(100, ((rssiValue - minRssi) / (maxRssi - minRssi)) * 100));
        verticalRssiBar.style.height = `${percentage}%`;
    };

    // --- Event Listeners ---
    connectTxButton.addEventListener('click', () => connectDevice('tx', TX_VID, TX_PID));
    disconnectTxButton.addEventListener('click', () => disconnectDevice('tx'));
    connectRxButton.addEventListener('click', () => connectDevice('rx', RX_VID, RX_PID));
    disconnectRxButton.addEventListener('click', () => disconnectDevice('rx'));

    rxEsbChannelSliderCol.addEventListener('input', (e) => {
        rxEsbChannelValueElCol.textContent = e.target.value;
    });

    rxEsbChannelSliderCol.addEventListener('change', (e) => {
        sendChannelToRX(parseInt(e.target.value, 10));
    });

    navigator.usb.addEventListener('disconnect', (event) => {
        if (txDevice && event.device.vendorId === TX_VID && event.device.productId === TX_PID) {
            disconnectDevice('tx');
        }
        if (rxDevice && event.device.vendorId === RX_VID && event.device.productId === RX_PID) {
            disconnectDevice('rx');
        }
    });

  </script>
</body>
</html>
